#!perl
use Cassandane::Tiny;

sub test_sessionstate
    :min_version_3_1 :ReverseACLs
    ($self)
{
    my $jmap = $self->{jmap};
    my $imaptalk = $self->{store}->get_client();
    my $admintalk = $self->{adminstore}->get_client();

    $self->{instance}->create_user("other");

    # Fetch sessionState
    my $JMAPRequest = {
        using => ['urn:ietf:params:jmap:core'],
        methodCalls => [['Core/echo', { }, 'R1']],
    };
    my $JMAPResponse = $jmap->request($JMAPRequest);
    $self->assert_not_null($JMAPResponse->wrapper_properties->{sessionState});
    my $sessionState = $JMAPResponse->wrapper_properties->{sessionState};

    # Update ACL
    $admintalk->setacl("user.other", "cassandane", "lr") or die;

    # Fetch sessionState
    $JMAPResponse = $jmap->request($JMAPRequest);
    $self->assert_str_not_equals($sessionState, $JMAPResponse->wrapper_properties->{sessionState});
    $sessionState = $JMAPResponse->wrapper_properties->{sessionState};

    # Update ACL
    $admintalk->setacl("user.other", "cassandane", "") or die;

    # Fetch sessionState
    $JMAPResponse = $jmap->request($JMAPRequest);
    $self->assert_str_not_equals($sessionState, $JMAPResponse->wrapper_properties->{sessionState});
}
