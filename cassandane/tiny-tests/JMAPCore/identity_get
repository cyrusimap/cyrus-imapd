#!perl
use Cassandane::Tiny;

sub test_identity_get
    :min_version_3_1
    :want_smtpdaemon
    ($self)
{
    my $jmap = $self->{jmap};

    my $using = [
        'urn:ietf:params:jmap:submission',
    ];

    my $res = $jmap->CallMethods([
        ['Identity/get', { accountId => 'cassandane'               }, 'R1'],
        ['Identity/get', { accountId => 'cassandane', ids => undef }, 'R2'],
        ['Identity/get', { accountId => 'cassandane', ids => []    }, 'R3'],
        ['Identity/get', { accountId => JSON::null                 }, 'R4'],
        ['Identity/get', {                                         }, 'R5'],
    ], $using);

    $self->assert_str_equals('Identity/get', $res->[0][0]);
    $self->assert_num_equals(1, scalar @{$res->[0][1]{list}});
    $self->assert_str_equals('cassandane', $res->[0][1]{list}[0]{id});
    $self->assert_not_null($res->[0][1]->{state});
    $self->assert_str_equals('R1', $res->[0][2]);

    $self->assert_num_equals(1, scalar @{$res->[1][1]{list}});
    $self->assert_str_equals('cassandane', $res->[1][1]{list}[0]{id});
    $self->assert_not_null($res->[1][1]->{state});

    $self->assert_deep_equals([], $res->[2][1]{list});
    $self->assert_not_null($res->[2][1]->{state});

    $self->assert_deep_equals([
        'error',
        {
            type => 'invalidArguments',
            arguments => [ 'accountId' ]
        },
        'R4'
        ], $res->[3]
    );

    $self->assert_deep_equals([
        'error',
        {
            type => 'invalidArguments',
            arguments => [ 'accountId' ]
        },
        'R5'
        ], $res->[4]
    );
}
