#!perl
use Cassandane::Tiny;

sub test_http_post_drop_connection1
{
    my ($self) = @_;

    # get a pristine connection
    $self->{store}->disconnect();
    my $talk = $self->{store}->get_client(NoLogin => 1);

    # consume initial capabilities response
    my ($ok, $capability) = $talk->_parse_response('', { IdleResponse => 1 });
    $self->assert_str_equals('ok', $ok);
    $self->assert_str_equals('capability', $capability);

    # mimic a HTTP client sending "POST / HTTP/1.1\r\n" command,
    # expect "* BYE This is an IMAP server" and disconnect
    # throws "IMAPTalk: Connection was unexpectedly closed by host"
    eval {
        imap_cmd_with_tag($talk, 'POST',
                                 '/', 0, '/',
                                 'HTTP/1.1');
    };
    # XXX can't see the real exception text cause cass obscures it,
    # XXX but there should have at least been some exception
    $self->assert_not_null($@);
    $self->assert_str_equals('This is an IMAP server',
                             $talk->get_response_code('bye'));

    # should be back to unconnected state
    $self->assert_num_equals(0, $talk->state());
}
