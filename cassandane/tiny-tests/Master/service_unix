#!perl
use Cassandane::Tiny;

sub test_service_unix
{
    my ($self) = @_;

    xlog $self, "single successful service on UNIX domain socket";
    my $srv = $self->lemming_service(
                        host => undef,
                        port => '@basedir@/conf/socket/lemming.sock');
    $self->start();

    xlog $self, "not preforked, so no lemmings running yet";
    $self->assert_deep_equals({},
                              $self->lemming_census());

    my $lemm = lemming_connect($srv);

    xlog $self, "connected so one lemming forked";
    $self->assert_deep_equals({ A => { live => 1, dead => 0 } },
                              $self->lemming_census());

    lemming_push($lemm, 'success');

    xlog $self, "no more live lemmings";
    $self->assert_deep_equals({ A => { live => 0, dead => 1 } },
                              $self->lemming_census());
}
