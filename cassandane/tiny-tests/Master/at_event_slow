#!perl
use Cassandane::Tiny;

sub test_at_event_slow
{
    my ($self) = @_;

    my $srv = $self->lemming_service(tag => 'A');

    # schedule some events to run a little after the current time, and check
    # that they do
    my @offsets = (1, 3, 20);

    my $now = time;
    my $localtz = DateTime::TimeZone->new(name => 'local');
    foreach my $offset (@offsets) {
        my $dt = DateTime->from_epoch(epoch => $now, time_zone => $localtz);
        $dt->add(minutes => $offset);
        my $hhmm = $dt->strftime('%H%M');
        $self->lemming_event(tag => $offset,
                             mode => 'success',
                             at => $hhmm);
    }
    $self->start();

    xlog $self, "waiting 5 mins for events to fire, plus some slop";
    sleep(5 * 60 + 5);

    $self->assert_deep_equals({
        '1'  => { live => 0, dead => 1 },
        '3'  => { live => 0, dead => 1 },
        # 20 shouldn't run
    }, $self->lemming_census());
}
