#!perl
use Cassandane::Tiny;
use Test::Deep ':v1';

sub test_dblookup_uid2emails
    :JMAPExtensions :NoAltNameSpace
{
    my ($self) = @_;
    my $jmap = $self->{jmap};
    my $imap = $self->{store}->get_client();
    my $admin = $self->{adminstore}->get_client();

    xlog "Create shared addressbooks";
    $admin->create("user.other");
    my $http = $self->{instance}->get_service("http");
    my $otherJmap = Mail::JMAPTalk->new(
        user => 'other',
        password => 'pass',
        host => $http->host(),
        port => $http->port(),
        scheme => 'http',
        url => '/jmap/',
    );

    $admin->create("user.other2");
    my $otherJmap2 = Mail::JMAPTalk->new(
        user => 'other2',
        password => 'pass',
        host => $http->host(),
        port => $http->port(),
        scheme => 'http',
        url => '/jmap/',
    );

    my $adminJmap = Mail::JMAPTalk->new(
        user => 'admin',
        password => 'pass',
        host => $http->host(),
        port => $http->port(),
        scheme => 'http',
        url => '/jmap/',
    );

    xlog $self, "Enable compactids";
    $self->{instance}->run_command({ cyrus => 1 },
                                   'ctl_conversationsdb', '-I', 'on', 'other');
    $self->{instance}->run_command({ cyrus => 1 },
                                   'ctl_conversationsdb', '-I', 'on', 'other2');

    $admin->create("user.other.#addressbooks.Shared", ['TYPE', 'ADDRESSBOOK']);
    my $abookId = $admin->get_response_code('mailboxid')->[0];
    $admin->setacl("user.other.#addressbooks.Shared", "cassandane", "lr") or die;
    $imap->subscribe("user.other.#addressbooks.Shared");

    $admin->create("user.other2.#addressbooks.Shared", ['TYPE', 'ADDRESSBOOK']);
    my $abookId2 = $admin->get_response_code('mailboxid')->[0];
    $admin->setacl("user.other2.#addressbooks.Shared", "cassandane", "lr") or die;
    $imap->subscribe("user.other2.#addressbooks.Shared");

    $admin->create("user.other2.#addressbooks.Shared2", ['TYPE', 'ADDRESSBOOK']);
    my $abookId3 = $admin->get_response_code('mailboxid')->[0];
    $admin->setacl("user.other2.#addressbooks.Shared2", "cassandane", "lr") or die;
    $imap->subscribe("user.other2.#addressbooks.Shared2");

    $admin->create("user.other2.#addressbooks.Unshared", ['TYPE', 'ADDRESSBOOK']);
    my $abookId4 = $admin->get_response_code('mailboxid')->[0];

    # translate mailboxids to addressbookids
    substr($abookId, 0, 1) = "R";
    substr($abookId2, 0, 1) = "R";
    substr($abookId3, 0, 1) = "R";
    substr($abookId4, 0, 1) = "R";

    my $using = [
        'urn:ietf:params:jmap:core',
        'urn:ietf:params:jmap:mail',
        'urn:ietf:params:jmap:contacts',
        'https://cyrusimap.org/ns/jmap/mail',
    ];

    xlog "Create contacts in shared addressbooks";
    my $res = $otherJmap->CallMethods([
        ['ContactCard/set', {
            create => {
                sharedContact => {
                    emails => {
                        e1 => {
                            address => 'sharedcontact@local'
                        }
                    },
                    addressBookIds => { $abookId => JSON::true }
                },
            },
        }, 'R1'],
    ], $using);
    my $sharedContactUid = $res->[0][1]{created}{sharedContact}{uid};
    $self->assert_not_null($sharedContactUid);

    $res = $otherJmap2->CallMethods([
        ['ContactCard/set', {
            create => {
                sharedContact2 => {
                    emails => {
                        e1 => {
                            address => 'sharedcontact2@local'
                        }
                    },
                    addressBookIds => { $abookId2 => JSON::true }
                },
                unsharedContact => {
                    emails => {
                        e1 => {
                            address => 'unsharedcontact@local'
                        }
                    },
                    addressBookIds => { $abookId4 => JSON::true }
                },
            },
        }, 'R1'],
    ], $using);
    my $sharedContactUid2 = $res->[0][1]{created}{sharedContact2}{uid};
    $self->assert_not_null($sharedContactUid2);
    my $unsharedContactUid = $res->[0][1]{created}{unsharedContact}{uid};
    $self->assert_not_null($unsharedContactUid);

    xlog "Create contact in own addressbook";
    $res = $jmap->CallMethods([
        ['ContactCard/set', {
            create => {
                ownContact => {
                    emails => {
                        e1 => {
                            address => 'ownContact@local'
                        }
                    },
                },
            },
        }, 'R1'],
    ], $using);
    my $ownContactUid = $res->[0][1]{created}{ownContact}{uid};
    $self->assert_not_null($ownContactUid);

    xlog "Create group in own addressbook";
    $res = $jmap->CallMethods([
        ['ContactCard/set', {
            create => {
                ownGroup => {
                    kind => 'group',
                    members => {
                        $sharedContactUid => JSON::true,
                        $sharedContactUid2 => JSON::true,
                    },
                    emails => {
                        e1 => {
                            address => 'ownGroup@local'
                        }
                    },
                },
            },
        }, 'R1'],
    ], $using);
    my $ownGroupUid = $res->[0][1]{created}{ownGroup}{uid};
    $self->assert_not_null($ownGroupUid);

    xlog "Create group in shared addressbook";
    $res = $otherJmap2->CallMethods([
        ['ContactCard/set', {
            create => {
                sharedGroup => {
                    kind => 'group',
                    members => {
                        $ownContactUid => JSON::true,
                        $sharedContactUid => JSON::true,
                    },
                    addressBookIds => { $abookId3 => JSON::true }
                },
            },
        }, 'R1'],
    ], $using);
    my $sharedGroupUid = $res->[0][1]{created}{sharedGroup}{uid};
    $self->assert_not_null($sharedGroupUid);

    my $dbLookupUrl = "http://"
        . $http->host . ":" . $http->port
        . "/dblookup/uid2emails";

    # lookup ownContactUid
    $res = $adminJmap->ua->get($dbLookupUrl, {
        headers => {
            User => 'cassandane',
            Key => $ownContactUid
        },
    });
    $self->assert_deep_equals([ 'ownContact@local' ],
                              decode_json($res->{content}));

    # lookup sharedContactUid
    $res = $adminJmap->ua->get($dbLookupUrl, {
        headers => {
            User => 'cassandane',
            Key => $sharedContactUid
        },
    });
    $self->assert_deep_equals([ 'sharedcontact@local' ],
                              decode_json($res->{content}));

    # other2 addressbook is NOT shared with cassandane
    $res = $adminJmap->ua->get($dbLookupUrl, {
        headers => {
            User => 'cassandane',
            Key => $unsharedContactUid
        },
    });
    $self->assert_str_equals('204', $res->{status});

    # lookup ownGroupUid
    $res = $adminJmap->ua->get($dbLookupUrl, {
        headers => {
            User => 'cassandane',
            Key => $ownGroupUid
        },
    });
    $self->assert_cmp_deeply(bag( 'ownGroup@local',
                                  'sharedcontact@local',
                                  'sharedcontact2@local' ),
                             decode_json($res->{content}));

    # lookup sharedGroupUid
    $res = $adminJmap->ua->get($dbLookupUrl, {
        headers => {
            User => 'cassandane',
            Key => $sharedGroupUid
        },
    });

    $self->assert_cmp_deeply(bag( 'ownContact@local',
                                  'sharedcontact@local' ),
                             decode_json($res->{content}));

    # own addressbook is NOT shared with other2
    $res = $adminJmap->ua->get($dbLookupUrl, {
        headers => {
            User => 'other2',
            Key => $ownContactUid
        },
    });
    $self->assert_str_equals('204', $res->{status});

    # shared addressbook is NOT shared with other2
    $res = $adminJmap->ua->get($dbLookupUrl, {
        headers => {
            User => 'other2',
            Key => $sharedContactUid
        },
    });
    $self->assert_str_equals('204', $res->{status});
}
