<!-- $Id: install-upgrade.html,v 1.18 2001/09/18 21:04:54 ken3 Exp $ -->
<HTML>
<HEAD>
<TITLE>Upgrading From Previous Versions
</title>
</head>
<h1>Upgrading From Previous Versions
</h1>

<body>

<h3>Upgrading from 2.0.16 or earlier</h3>

<ul>
<li> If you use <tt>timsieved</tt> to manage Sieve scripts, and have
enabled the alternate namespace and/or the Unix hierarchy separator,
run the script "<tt>tools/translatesieve</tt>".  This script will
translate the folder names in <tt>fileinto</tt> actions.

<li> If you have enabled the improved directory hashing scheme, run
the script "<tt>tools/rehash full</tt>".  This script will rehash your
existing directories.

<li> The hashed deliver databases (used for duplicate delivery suppression
and Sieve) have been merged into a single <tt>deliver.db</tt> database.
You can remove the entire <tt>/var/imap/deliverdb</tt> directory structure 
after shutting down the server.

<li>All of the Cyrus databases have been unified under a single DB3 
environment.  A new <tt>ctl_cyrusdb</tt> tool is now used for database 
recovery and checkpointing instead of <tt>ctl_mboxlist</tt> and 
<tt>ctl_deliver</tt>.  You should replace the appropriate <tt>START</tt> and 
<tt>EVENTS</tt> entries in <tt>cyrus.conf</tt> with those in the 
sample configurations in the <tt>master/conf</tt> directory.

<li> Cyrus now caches SSL/TLS sessions in an external database. If you
have support for SSL/TLS, and haven't disabled session caching (see
<tt>imapd.conf(5)</tt>), you should add a line like the following to
the <tt>EVENTS</tt> section of <tt>cyrus.conf</tt> to prune expired
sessions from the database:

<pre><kdb>   # this is only necessary if caching TLS sessions
   tlsprune      cmd="tls_prune" period=1440
</kbd></pre>
</ul>

<h3>Upgrading from 2.0.6, 2.0.7, 2.0.8, or 2.0.9 or earlier</h3>

<ul>
<li> If you use <tt>timsieved</tt> to manage Sieve scripts, run the
script "<tt>tools/upgradesieve</tt>".  <tt>timsieved</tt> now uses
symlinks instead of hard links.
</ul>

<h3>Upgrading from a previous 2.0 version to 2.0.6</h3>

<b>Warning:</b> You do not need to follow these instructions if you're
upgrading from version 1.6.

<ul>
<li>You can now pick whether to use Berkeley db to store seen state,
the subscription files, and the mailboxes file or a flat text file, at
compile time only.  (Look in <tt>imap/seen_db.c</tt> and
<tt>imap/mboxlist.h</tt>.)

<li>The format of the mailboxes file and seen state has changed.  It is
not possible to preserve seen state, but upgrade the mailboxes file as
follows:
<ol>
<li> Run <tt>ctl_mboxlist -d &gt; mboxlist.temp</tt> to dump existing
mailboxes.

<li> Remove old database files: <tt>rm mailboxes.db db/*
user/*/*.seen</tt>

<li>With the new version of ctl_mboxlist, run <tt>ctl_mboxlist -u &lt;
mboxlist.temp</tt>.
</ol>
</ul>

<h3>Upgrading from 1.6.22 or 1.6.24</h3>

<b>Warning:</b> Cyrus imapd 2.0 will automatically convert on-disk
file formats as the server is used.  <b>It is not possible to run 1.6
after 2.0 has been used on a mail spool without reconstructing every
mailbox.</b>

<ul>
<li>Create some extra directories and remove the duplicate delivery
database:
<pre>
<kbd>   mkdir /var/imap/db
   mkdir /var/imap/socket
   chown cyrus /var/imap/db /var/imap/socket
   rm /var/imap/deliverdb/*
</kbd></pre>

<li>Convert mailboxes file to Berkeley DB:
<pre>
<kbd>   su cyrus
   cd /var/imap
   ctl_mboxlist -u &lt; mailboxes
   ctl_mboxlist -c
</kbd></pre>

Please keep a backup of your mailboxes file.  You can dump an
old-style mailboxes file by using <tt>ctl_mboxlist -d</tt>.

<li>remove "<tt>/etc/inetd.conf</tt>" entries. The <tt>imap</tt> and
<tt>popd3d</tt> lines need to be removed from <tt>/etc/inetd.conf</tt>
and inetd needs to be restarted.

<li>master process configuration: You'll need to configure the master
process Cyrus process and ensure that it starts on boot.  see <a
href="install-configure.html#master">this section</a> of the
configuration instructions.

<li>sendmail configuration. You need to use a new cyrus mc file. See
<a href="cyrusv2.mc"><tt>doc/cyrusv2.mc</tt></a> for a sample mc
file. This requires Sendmail 8.10 or newer.  See <a
href="install-configure.html#mta">this section</a> of the
configuration document.

<li>cyrus.seen conversion. The cyrus.seen file will be automatically
upgraded as users read mail.  After some time, you might want to
delete the cyrus.seen file in each mailbox; it is superceded by the
user/joe.seen file.

<li>cyrus.index conversion.  The cyrus.index file will be
automatically upgraded the first time each mailbox is SELECTed.

<li>Netnews conversion. The netnews programs are no longer built. If
you are using netnews, you will need to apply the diff in the
<tt>netnews/</tt> directory to INN or see if INN is now distributing
those changes.  You will also want to run <tt>remotepurge</tt> on a
regular basis to purge old netnews posts.

</ul>


<h3>Upgrading from 1.6.13</h3>
<ul>
<li> Upgrading from the Cyrus IMAP server version 1.6.13 or earlier:
if you use Sieve, you should run the "<tt>tools/upgradesieve</tt>"
script, as the format of the "<tt>/usr/sieve</tt>" directory has
changed slightly.

<p>timsieved, included in this release, will handle maintenance of Sieve
scripts.

<li> Upgrading from the Cyrus IMAP server version 1.6.10 or earlier:
if you export news via the IMAP server, you'll have to change your
"<tt>newsfeeds</tt>" file to contain
<pre>collectnews!:*:Tf,WR:collectnews</pre>  The format of the
input to collectnews has changed.

<p>Duplicate delivery suppression is now required for Sieve.

<li> Upgrading from the Cyrus IMAP server version 1.6.1 or earlier
(including 1.5.x!): the quota and user directories are now hashed by
the first character of the username.  This is to reduce the number of
entries in any given directory. It doesn't do a great job (and in some
cases it will do a really poor job) but as a quick hack it shouldn't
make things worse.  Optionally, the data partitions can also be hashed
by enabling the "hashimapspool" option.

<p>You must hash your directories using the "<tt>dohash</tt>" script
in the tools subdirectory.  (If you want to hash your mail spool, be
sure to set "hashimapspool" before running "<tt>dohash</tt>".)  This
must be run as the Cyrus user. Be sure to stop mail service while
converting. Doing this in single user mode is probably the safest.

</ul>

<h3>Upgrading from 1.5</h3>
<ul>
<li> Upgrading from the Cyrus IMAP server version 1.5 or earlier:
libsasl is now required.  Configuring SASL to work may be a chore,
especially if you use shadow passwords.

<li> An ANSI C compiler is now required.  gcc should work fine and can
be acquired from <a href="http://www.gnu.org/software/gcc/gcc.html">
http://www.gnu.org/software/gcc/gcc.html</a>.

<li> Make sure to read the upgrading instructions under 1.6 above.

<li> Upgrading from 1.5.14 or earlier requires deleting the delivered
database.  Remove the file delivered.db in the configdirectory and make a
directory called "deliverdb" in the configdirectory.  This may cause some
duplicates to get through.

<li> Upgrading from 1.5.14 or earlier requires removing the PTS cache
database (if the AFS PTS group support is used, which is not the
default).  The PTS cache is in /var/ptclient/ptscache.db, and you
should remove it. This is because the format for the PTS cache for
IMSP has changed.  If you use AFS ACLs, IMSPd, and IMAPd on the same
machine, make sure you have version 1.5a5 of the IMSP server for this
version of the IMAP server.  (If you don't have IMSP, or AFS, don't
worry about it.)

</ul>

<P><HR><P>
last modified: $Date: 2001/09/18 21:04:54 $
</BODY></HTML>


